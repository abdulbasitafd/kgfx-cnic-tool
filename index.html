<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ID Card Print Tool v1.2.0</title>
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="theme-color" content="#007bff">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f0f0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .controls input[type="file"],
    .controls select,
    .controls button {
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .controls button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      border: none;
      transition: background-color 0.3s ease;
    }
    .controls button:hover {
      background-color: #0056b3;
    }
    .drop-area {
      border: 2px dashed #007bff;
      padding: 20px;
      text-align: center;
      border-radius: 10px;
      color: #666;
      cursor: pointer;
    }
    .drop-area.dragover {
      background-color: #e0e0ff;
      border-color: #0056b3;
    }
    .status {
      font-size: 14px;
      color: green;
    }
    .compression-controls {
      margin-top: 10px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    .compression-controls label {
      display: block;
      margin-bottom: 5px;
    }
    
    /* Refined layout for A4 pages */
    .print-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .a4-page {
      width: 210mm;
      height: 297mm;
      margin: 20px auto;
      background: white;
      padding: 10mm;
      box-sizing: border-box;
      border: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .id-row {
      display: flex;
      justify-content: center;
      margin-bottom: 10mm;
      height: 2.3in;
      gap: 7mm;
      width: 100%;
    }

    .id-image {
      width: 3.7in; 
      height: 2.3in;
      border: 1.3px solid #000000;
      border-radius: 15px;
      object-fit: cover;
    }

    /* Improved print styles */
    @media print {
      @page {
        size: A4;
        margin: 0;
      }
      
      html, body {
        width: 210mm;
        height: 297mm;
        margin: 0;
        padding: 0;
        background-color: #fff;
      }
      
      .container, .controls {
        display: none !important;
      }
      
      .print-container {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        margin: 0;
        padding: 0;
        gap: 0;
      }
      
      .a4-page {
        width: 210mm;
        height: 297mm;
        padding: 10mm;
        margin: 0;
        border: none;
        page-break-after: always;
        break-after: page;
        box-shadow: none;
      }
      
      .a4-page:last-child {
        page-break-after: auto;
        break-after: auto;
      }
    }
    
    /* New styles for duplicate canvas feature */
    .duplicate-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    
    .duplicate-controls input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .duplicate-controls label {
      font-size: 16px;
      cursor: pointer;
      user-select: none;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ID Card Print Tool</h1>
  <div class="controls">
    <button id="toggleMode">Toggle Mode: Single</button>
    <div id="personInputs"></div>
    <button id="addPerson">Add Person</button>
    
    <div class="compression-controls">
      <label for="imageQuality">Image Quality:</label>
      <input type="range" id="imageQuality" min="10" max="100" value="60" step="5">
      <span id="qualityValue">60%</span>
      
      <label for="maxWidth">Max Width (pixels):</label>
      <input type="number" id="maxWidth" min="300" max="2000" value="800" step="50">
      
      <label for="maxHeight">Max Height (pixels):</label>
      <input type="number" id="maxHeight" min="300" max="2000" value="500" step="50">
    </div>
    
    <div class="duplicate-controls">
      <input type="checkbox" id="duplicateCanvas">
      <label for="duplicateCanvas">Duplicate Canvas</label>
    </div>
    
    <button id="generateBtn" onclick="generateLayout()">Generate Layout</button>
    <button id="printBtn" onclick="printPages()">Print</button>
  </div>
</div>
<div class="print-container" id="printArea"></div>

<script>
  let mode = 'single';
  let persons = [];
  let optimizedImages = {};
  let nextImageId = 0;

  document.getElementById('toggleMode').addEventListener('click', () => {
    mode = mode === 'single' ? 'multi' : 'single';
    document.getElementById('toggleMode').textContent = 'Toggle Mode: ' + (mode === 'single' ? 'Single' : 'Multi');
    document.getElementById('addPerson').style.display = mode === 'multi' ? 'block' : 'none';
    persons = [];
    optimizedImages = {};
    document.getElementById('personInputs').innerHTML = '';
    document.getElementById('printArea').innerHTML = '';
    addPerson();
  });

  document.getElementById('addPerson').addEventListener('click', () => {
    if (persons.length < 4) addPerson();
  });
  
  // Update quality value display
  document.getElementById('imageQuality').addEventListener('input', function() {
    document.getElementById('qualityValue').textContent = this.value + '%';
  });

  function addPerson() {
    const index = persons.length;
    persons.push({ front: '', back: '', copies: 2, frontImageId: null, backImageId: null });

    const container = document.createElement('div');
    container.innerHTML = `
      <div class="drop-area" onclick="document.getElementById('front${index}').click()">Upload Front (Person ${index + 1})</div>
      <input type="file" id="front${index}" accept="image/*" style="display:none;" onchange="loadImage(event, ${index}, 'front')">
      <div id="statusFront${index}" class="status"></div>
      <div class="drop-area" onclick="document.getElementById('back${index}').click()">Upload Back (Person ${index + 1})</div>
      <input type="file" id="back${index}" accept="image/*" style="display:none;" onchange="loadImage(event, ${index}, 'back')">
      <div id="statusBack${index}" class="status"></div>
      <label>Copies:</label>
      <select onchange="setCopies(${index}, this.value)">
        <option value="2">2 Copies</option>
        <option value="4">4 Copies</option>
        <option value="6">6 Copies</option>
        <option value="8">8 Copies</option>
      </select>
      <hr>
    `;
    document.getElementById('personInputs').appendChild(container);
  }

  function loadImage(event, index, type) {
    const reader = new FileReader();
    reader.onload = function(e) {
      persons[index][type] = e.target.result;
      
      // Optimize the image when it's loaded
      optimizeImage(e.target.result, index, type);
    };
    reader.readAsDataURL(event.target.files[0]);
  }

  function optimizeImage(dataUrl, personIndex, imageType) {
    const img = new Image();
    img.onload = () => {
      const quality = parseInt(document.getElementById('imageQuality').value) / 100;
      const maxWidth = parseInt(document.getElementById('maxWidth').value);
      const maxHeight = parseInt(document.getElementById('maxHeight').value);
      
      // Create canvas for resizing
      const canvas = document.createElement('canvas');
      let width = img.width;
      let height = img.height;
      
      // Calculate new dimensions while maintaining aspect ratio
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      if (height > maxHeight) {
        width = (width * maxHeight) / height;
        height = maxHeight;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      // Draw and compress the image
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      
      // Convert to optimized data URL
      const optimizedDataUrl = canvas.toDataURL('image/jpeg', quality);
      
      // Assign a unique ID to this optimized image
      const imageId = 'img_' + nextImageId++;
      optimizedImages[imageId] = optimizedDataUrl;
      
      // Store the reference to this image ID
      persons[personIndex][imageType + 'ImageId'] = imageId;
      
      // Update status to show compression info
      const originalSize = Math.round(dataUrl.length / 1024);
      const optimizedSize = Math.round(optimizedDataUrl.length / 1024);
      const savings = Math.round(((originalSize - optimizedSize) / originalSize) * 100);
      
      document.getElementById(`status${imageType.charAt(0).toUpperCase() + imageType.slice(1)}${personIndex}`).textContent = 
        `${imageType.charAt(0).toUpperCase() + imageType.slice(1)} image uploaded âœ“ (Reduced from ${originalSize}KB to ${optimizedSize}KB, ${savings}% smaller)`;
    };
    
    img.src = dataUrl;
  }

  function setCopies(index, value) {
    persons[index].copies = parseInt(value);
  }

  function generateLayout() {
    const printArea = document.getElementById('printArea');
    printArea.innerHTML = '';
    let totalCopies = [];
    const isDuplicateChecked = document.getElementById('duplicateCanvas').checked;

    if (mode === 'single') {
      if (!persons[0]) persons.push({ front: '', back: '', copies: 2, frontImageId: null, backImageId: null });
      const person = persons[0];
      if (!person.frontImageId || !person.backImageId) return alert('Upload both front and back images');
      for (let i = 0; i < person.copies / 2; i++) totalCopies.push(person);
    } else {
      for (const person of persons) {
        if (!person.frontImageId || !person.backImageId) return alert('Upload all front and back images');
        for (let i = 0; i < person.copies / 2; i++) totalCopies.push(person);
      }
    }

    let page = null;
    let itemsPerPage = 4; // 4 rows per page
    let allPages = []; // Store all created pages
    
    for (let i = 0; i < totalCopies.length; i++) {
      if (i % itemsPerPage === 0) {
        page = document.createElement('div');
        page.className = 'a4-page';
        allPages.push(page); // Store the page
      }
      
      const row = document.createElement('div');
      row.className = 'id-row';
      
      const front = document.createElement('img');
      front.className = 'id-image';
      front.src = optimizedImages[totalCopies[i].frontImageId];
      
      const back = document.createElement('img');
      back.className = 'id-image';
      back.src = optimizedImages[totalCopies[i].backImageId];
      
      row.appendChild(front);
      row.appendChild(back);
      page.appendChild(row);
    }
    
    // New duplicate canvas functionality - add pages in sequence
    if (isDuplicateChecked) {
      allPages.forEach(originalPage => {
        printArea.appendChild(originalPage); // Add original
        const duplicatedPage = originalPage.cloneNode(true);
        printArea.appendChild(duplicatedPage); // Add duplicate right after
      });
    } else {
      // Add original pages to print area
      allPages.forEach(page => printArea.appendChild(page));
    }
    
    // Scroll to show the preview
    printArea.scrollIntoView({ behavior: 'smooth' });
  }

  function printPages() {
    if (document.getElementById('printArea').children.length === 0) {
      alert('Please generate the layout first');
      return;
    }
    window.print();
  }

  window.onload = () => {
    addPerson();
    document.getElementById('addPerson').style.display = 'none';
  };
</script>
</body>
</html>
